---
title: 30分钟写一个天气查询网站
date: 2025-11-21 10:29:18
category:
  - 技术
tags:
  - 前端
  - Python
---

本文使用 CGI 编写一个极其简单的天气查询网站，只需要实现一个 `index.html` 页面和一个 `weather.py` 脚本（调用高德天气 API）即可。CGI 是一种相对原始的协议，服务器接收形如 `<path/to/script?parameters>` 的请求时，每次创建一个新的进程运行该脚本响应。因为每次请求都要创建新进程，开销较大且资源浪费，因此在现代 Web 开发中已较少使用。CGI 的现代替代方案是 WSGI，它允许应用程序作为一个长期运行的进程或线程存在于内存中，服务器可以直接调用内存中的代码，因而提高了性能，Flask, Django 等主流 Web 框架都基于 WSGI 而非 CGI。本项目目录结构如图：

```plaintext
weather-info/
└─cgi-bin/
    └─weather.py
└─index.html
```

首先把前端页面写出来：

```html
<!DOCTYPE html>
<html>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</html>
<body>
  <h1>Weather Information</h1>
  <!-- 查询部分 -->
  <p>
    <input type="text" id="city_input" />
    <button type="submit" name="submit">Show</button>
  </p>
  <!-- 展示部分，后续用 JS 替换掉 span 里的内容 -->
  <p>
    <b>City</b>: <span id="city">北京</span><br />
    <b>Weather</b>: <span id="weather">晴</span><br />
    <b>Temperature</b>: <span id="temperature">0</span> ℃ <br />
    <b>Humidity</b>: <span id="humidity">0</span>%<br />
  </p>
</body>
```

用 `python -m http.server --cgi 8000` 启动 CGI 服务器，在 `localhost:8000` 确认前端的效果无误后，接下来的任务是：

1. 取出 `<input>` 输入的 `city_input`，使用 CGI 协议启动后端脚本，查询对应城市并接收脚本返回的 JSON 信息，渲染到界面上。这一部分用 Javascript 写在 `<script>` 标签里。
2. 后端 Python 脚本接收城市名参数，调用高德地图天气 API，整理 JSON 发回前端页面。

我们先写后端脚本 `cgi-bin/weather.py`。根据高德开放平台的文档，注册账号，创建应用，可以拿到自己的 `API_KEY` 以及 API 链接 `https://restapi.amap.com/v3/weather/weatherInfo?city={adcode}&key={key}`。

注意到 API 不支持直接按照城市名称查询，而是需要查询城市对应的 adcode。经过寻找，在 [这个页面](https://lbs.amap.com/api/webservice/download) 下载城市编码表。表格给定了城市对应的 adcode，如图所示。我们只需实现一个 `get_adcode(city_name)` 函数，读取 xlsx 文件，查表并返回 adcode 即可。

{% asset_img adcode_table.png 城市编码表 %}

我们把城市编码表 AMap_adcode_citycode.xlsx 放在 weather.py 的同级目录下，即 `cgi-bin/AMap_adcode_citycode.xlsx`，则 `get_adcode(city_name)` 如下：

```py
from openyxl import load_workbook
import pathlib

def get_adcode(city_name: str):
    # 利用 pathlib 从 weather.py 的位置推出 xlsx 的位置
    script_dir = pathlib.Path(__file__).resolve().parent
    file_name = 'AMap_adcode_citycode.xlsx'
    file_path = str(script_dir / file_name)

    # 加载 excel 文件
    workbook = load_workbook(file_path)
    sheet = workbook.active

    # 遍历每一行（第一行为表头，从第二行开始）
    for row in sheet.iter_rows(min_row=2):
        current_city = str(row[0].value).strip(
        ) if row[0].value is not None else ""

        # current_city 均为行政区划全名，这里 current_city 包含 city_name 即认为匹配
        if city_name.strip() in current_city:
            arcode_value = row[1].value
            return str(arcode_value).strip()

    return None
```

构建了城市名对 adcode 的映射后，我们先固定 `city_name`，查询一下吧：

```py
city_name = "东城区"
API_KEY = "your/api/key"

api = "https://restapi.amap.com/v3/weather/weatherInfo?city={adcode}&key={key}"
url = api.format(adcode=get_adcode(city_name), key=API_KEY)

response = requests.get(url)
data = response.json()
print(data)
```

打印出来的结果是：

```json
{
  "status": "1",
  "count": "1",
  "info": "OK",
  "infocode": "10000",
  "lives": [
    {
      "province": "北京",
      "city": "东城区",
      "adcode": "110101",
      "weather": "晴",
      "temperature": "13",
      "winddirection": "南",
      "windpower": "≤3",
      "humidity": "19",
      "reporttime": "2025-11-21 11:07:39",
      "temperature_float": "13.0",
      "humidity_float": "19.0"
    }
  ]
}
```

这就是完整的 JSON 返回值，我们不需要这么多信息，这里只取出城市、天气、温度、湿度打包发回前端：

```py
responseData = {
    "city": data["lives"][0]["city"], # 注意加中间的 [0]，"lives" 是一个列表
    "weather": data["lives"][0]["weather"],
    "temperature": data["lives"][0]["temperature"],
    "humidity": data["lives"][0]["humidity"]
}
jsonText = json.dumps(responseData, indent=4)
# CGI 协议中，服务器将脚本的全部标准输出作为返回值，print 了就是发送了
# 因此需要特别注意输出格式，e.g. 先输出 header，不要输出调试语句等
# ——记得注释掉上上个代码块的 print(data)
print("Content-type: text/json\n")
print(jsonText)
```

回到前端，我们编写前后端交互和渲染页面的部分，主要实现 `showWeatherInfo()` 和 `updatePage()` 两个函数。

```js
var request = new XMLHttpRequest(); // 创建 request 对象，readyState == 0

function showWeatherInfo() {
  // 查询天气信息，绑定到 button 的 onclick 事件
  var city_input = document.getElementById("city_input").value;
  // 通过查询参数传递城市名称，后端使用 FieldStorage 获取参数
  var url = encodeURI("/cgi-bin/weather.py?city=" + city_input);
  request.open("GET", url, true); // open() 初始化 request 对象，readyState == 1
  request.onreadystatechange = updatePage; // updatePage 绑定到 onreadystatechange 事件，每次 readyState 改变都自动调用
  request.send(null); // 发送请求，收到 header 后 readyState == 2，接受 body 中 readyState == 3
}

function updatePage() {
  if (request.readyState == 4) {
    // 完全接受后 readyState == 4，可以安全使用
    if (request.status == 200) {
      var replyDoc = JSON.parse(request.responseText);
      // city
      var city = replyDoc.city;
      var cityElement = document.getElementById("city");
      cityElement.removeChild(cityElement.firstChild);
      cityElement.appendChild(document.createTextNode(city));
      // weather
      var weather = replyDoc.weather;
      var weatherElement = document.getElementById("weather");
      weatherElement.removeChild(weatherElement.firstChild);
      weatherElement.appendChild(document.createTextNode(weather));
      // temperature
      var temperature = replyDoc.temperature;
      var temperatureElement = document.getElementById("temperature");
      temperatureElement.removeChild(temperatureElement.firstChild);
      temperatureElement.appendChild(document.createTextNode(temperature));
      // humidity
      var humidity = replyDoc.humidity;
      var humidityElement = document.getElementById("humidity");
      humidityElement.removeChild(humidityElement.firstChild);
      humidityElement.appendChild(document.createTextNode(humidity));
    }
  }
}
```

然后把 `showWeatherInfo()` 绑定到 `<button>` 上，即 `<button type="submit" name="submit" onclick="showWeatherInfo()">Show</button>`。这样，当我们点击按钮后，输入框中的文本 `东城区` 将会被以 `GET /cgi-bin/weather.py?city=东城区` 形式发往后端（如前所述，开启一个新的进程运行 weather.py 脚本，脚本通过 FieldStorage 接收参数并且打印到标准输出）。

现在，我们只需要补全 weather.py，让它拿到参数 `city_name` 即可——把 `city_name = '东城区'` 替换为：

```py
form = cgi.FieldStorage()
city_name = form.getvalue('city', '东城区')
```

一个简单的天气查询网站就开发完成了，效果如图所示：

{% asset_img weather.png 查询结果 %}
